<!DOCTYPE html>
<html>
<head>
    <title>Customize Chart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 10px;
            border: 1px solid #ddd;
        }
        .preview-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Chart App</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, {{ session.username }}!</span>
                <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('my_data') }}">My Data</a>
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Customize Chart: {{ data.chart_name }}</h2>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-md-6">
                <form method="POST" id="customizeForm">
                    <div class="card">
                        <div class="card-header">
                            <h5>Chart Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Chart Title</label>
                                <input type="text" class="form-control" name="chart_title" value="{{ data.chart_title }}" placeholder="Enter chart title">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">X-Axis Label</label>
                                <input type="text" class="form-control" name="x_axis_label" value="{{ data.x_axis_label }}" placeholder="Enter X-axis label">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Y-Axis Label</label>
                                <input type="text" class="form-control" name="y_axis_label" value="{{ data.y_axis_label }}" placeholder="Enter Y-axis label">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Custom Colors</label>
                                {% for row_index in range(data.rows|length) %}
                                <div class="input-group mb-2">
                                    <span class="input-group-text">{{ data.rows[row_index] }}</span>
                                    {% set default_color = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'][row_index % 6] %}
                                    {% set current_color = data.custom_colors[row_index] if data.custom_colors and row_index < data.custom_colors|length else default_color %}
                                    <input type="color" class="form-control form-control-color" 
                                           name="color_{{ row_index }}" 
                                           value="{{ current_color }}"
                                           title="Choose color for {{ data.rows[row_index] }}">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                        <button type="button" class="btn btn-success" onclick="downloadChart()">
                            <i class="fas fa-download"></i> Download Chart
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Live Preview</h5>
                    </div>
                    <div class="card-body preview-container">
                        <canvas id="previewChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store chart data from template
        const chartData = {
            chartName: "{{ data.chart_name }}",
            dataType: "{{ data.data_type }}",
            columns: {{ data.columns | tojson }},
            rows: {{ data.rows | tojson }},
            dataValues: {{ data.data_values | tojson }},
            chartTitle: "{{ data.chart_title }}",
            xAxisLabel: "{{ data.x_axis_label }}",
            yAxisLabel: "{{ data.y_axis_label }}",
            customColors: {{ data.custom_colors | tojson if data.custom_colors else '[]' }}
        };

        // Default colors
        const defaultColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC926', '#1982C4'
        ];
        
        let previewChart = null;
        
        function getDefaultColor(index) {
            return defaultColors[index % defaultColors.length];
        }
        
        // Initialize preview chart
        function initializePreview() {
            const ctx = document.getElementById('previewChart').getContext('2d');
            const form = document.getElementById('customizeForm');
            
            // Get current values from form
            const chartTitle = form.chart_title.value || chartData.chartName;
            const xAxisLabel = form.x_axis_label.value;
            const yAxisLabel = form.y_axis_label.value;
            
            // Get custom colors from form inputs or use defaults
            const customColors = [];
            for (let i = 0; i < chartData.rows.length; i++) {
                const colorInput = form.querySelector(`[name="color_${i}"]`);
                customColors.push(colorInput.value || getDefaultColor(i));
            }
            
            // Create datasets
            const datasets = chartData.rows.map((row, rowIndex) => {
                return {
                    label: row,
                    data: chartData.dataValues[rowIndex],
                    backgroundColor: customColors[rowIndex],
                    borderColor: customColors[rowIndex],
                    borderWidth: 2
                };
            });
            
            // Destroy existing chart if it exists
            if (previewChart) {
                previewChart.destroy();
            }
            
            // Chart configuration based on chart type
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: chartTitle
                    }
                }
            };

            // Add scales for non-pie/doughnut charts
            if (chartData.dataType !== 'pie' && chartData.dataType !== 'doughnut') {
                commonOptions.scales = {
                    x: {
                        title: {
                            display: !!xAxisLabel,
                            text: xAxisLabel
                        }
                    },
                    y: {
                        title: {
                            display: !!yAxisLabel,
                            text: yAxisLabel
                        },
                        beginAtZero: true
                    }
                };
            }
            
            previewChart = new Chart(ctx, {
                type: chartData.dataType,
                data: {
                    labels: chartData.columns,
                    datasets: datasets
                },
                options: commonOptions
            });
        }
        
        // Update preview when form changes
        document.getElementById('customizeForm').addEventListener('input', initializePreview);
        
        // Download chart as image
        function downloadChart() {
            if (!previewChart) {
                alert('Please wait for the chart to load');
                return;
            }
            
            const canvas = document.getElementById('previewChart');
            html2canvas(canvas).then(canvas => {
                const link = document.createElement('a');
                link.download = chartData.chartName + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Chart data:', chartData); // Debug log
            
            // Set default colors in form inputs if they're empty
            const form = document.getElementById('customizeForm');
            for (let i = 0; i < chartData.rows.length; i++) {
                const colorInput = form.querySelector(`[name="color_${i}"]`);
                if (!colorInput.value) {
                    colorInput.value = getDefaultColor(i);
                }
            }
            
            // Initialize the preview
            initializePreview();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

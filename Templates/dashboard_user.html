<!DOCTYPE html>
<html>
<head>
    <title>User Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Chart App</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, {{ username }}!</span>
                <a class="nav-link" href="{{ url_for('add_data') }}">Add Data</a>
                <a class="nav-link" href="{{ url_for('my_data') }}">My Data</a>
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-12">
                <h1>User Dashboard</h1>
                <p class="lead">Create and view your charts</p>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Get Started</h5>
                        <p>Add your first chart data to get started with visualizing your information.</p>
                        <a href="{{ url_for('add_data') }}" class="btn btn-success">Add Your First Chart</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mt-4">
            <div class="col-12">
                <h3>My Charts & Shared Charts</h3>
                <div id="chartsContainer" class="row">
                    <!-- Charts will be loaded here by JavaScript -->
                    <div class="col-12">
                        <div class="alert alert-info" id="noChartsMessage" style="display: none;">
                            No chart data found. <a href="{{ url_for('add_data') }}">Add your first chart</a> to get started!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript to load charts dynamically -->
    <script>
    // Store chart data globally for edit functionality
    let allChartsData = [];

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/my-chart-data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(charts => {
                allChartsData = charts; // Store for later use
                const container = document.getElementById('chartsContainer');
                const noChartsMessage = document.getElementById('noChartsMessage');
                
                if (charts.length === 0) {
                    noChartsMessage.style.display = 'block';
                    return;
                }
                
                noChartsMessage.style.display = 'none';
                
                charts.forEach((chart, index) => {
                    const chartCol = document.createElement('div');
                    chartCol.className = 'col-md-6 mb-4';
                    
                    const chartCard = document.createElement('div');
                    chartCard.className = 'card';
                    
                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'card-header bg-light d-flex justify-content-between align-items-center';
                    
                    const chartTitle = document.createElement('h5');
                    chartTitle.className = 'card-title mb-0';
                    if (chart.is_shared) {
                        chartTitle.innerHTML = `${chart.chart_name} <small class="text-muted">(by ${chart.owner_username})</small>`;
                    } else {
                        chartTitle.textContent = chart.chart_name;
                    }
                    
                    // Dropdown menu for chart options (only show for own charts)
                    if (!chart.is_shared) {
                        const dropdown = document.createElement('div');
                        dropdown.className = 'dropdown';
                        
                        const dropdownButton = document.createElement('button');
                        dropdownButton.className = 'btn btn-sm btn-outline-secondary dropdown-toggle';
                        dropdownButton.type = 'button';
                        dropdownButton.setAttribute('data-bs-toggle', 'dropdown');
                        dropdownButton.setAttribute('aria-expanded', 'false');
                        dropdownButton.innerHTML = '<i class="fas fa-cog"></i>';
                        
                        const dropdownMenu = document.createElement('ul');
                        dropdownMenu.className = 'dropdown-menu';
                        
                        // Edit Data option
                        const editItem = document.createElement('li');
                        const editLink = document.createElement('a');
                        editLink.className = 'dropdown-item';
                        editLink.href = `/edit-data/${chart.id}`;
                        editLink.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Data';
                        editItem.appendChild(editLink);
                        
                        // Customize Styles option
                        const stylesItem = document.createElement('li');
                        const stylesLink = document.createElement('a');
                        stylesLink.className = 'dropdown-item';
                        stylesLink.href = `/customize-chart/${chart.id}`;
                        stylesLink.innerHTML = '<i class="fas fa-palette me-2"></i>Customize Styles';
                        stylesItem.appendChild(stylesLink);
                        
                        dropdownMenu.appendChild(editItem);
                        dropdownMenu.appendChild(stylesItem);
                        
                        dropdown.appendChild(dropdownButton);
                        dropdown.appendChild(dropdownMenu);
                        
                        cardHeader.appendChild(chartTitle);
                        cardHeader.appendChild(dropdown);
                    } else {
                        // For shared charts, just show the title and a shared badge
                        const sharedBadge = document.createElement('span');
                        sharedBadge.className = 'badge bg-info';
                        sharedBadge.textContent = 'Shared';
                        
                        const titleContainer = document.createElement('div');
                        titleContainer.className = 'd-flex align-items-center';
                        titleContainer.appendChild(chartTitle);
                        titleContainer.appendChild(sharedBadge);
                        
                        cardHeader.appendChild(titleContainer);
                    }
                    
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    
                    const canvas = document.createElement('canvas');
                    canvas.id = `chart-${chart.id}-${index}`;
                    canvas.height = '250';

<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Chart App - Admin</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, {{ username }}!</span>
                <a class="nav-link" href="{{ url_for('add_data') }}">Add Data</a>
                <a class="nav-link" href="{{ url_for('my_data') }}">My Data</a>
                <a class="nav-link" href="{{ url_for('manage_users') }}">Manage Users</a>
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-12">
                <h1>Admin Dashboard</h1>
                <p class="lead">Manage your chart data and users</p>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Quick Actions</h5>
                        <a href="{{ url_for('add_data') }}" class="btn btn-primary me-2">Add New Chart Data</a>
                        <a href="{{ url_for('my_data') }}" class="btn btn-info me-2">View My Data</a>
                        <a href="{{ url_for('manage_users') }}" class="btn btn-warning">Manage Users</a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Admin Features</h5>
                        <p class="card-text">As an admin, you have access to all features including user management and system settings.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mt-4">
            <div class="col-12">
                <h3>My Charts & Shared Charts</h3>
                <div id="chartsContainer" class="row">
                    <!-- Charts will be loaded here by JavaScript -->
                    <div class="col-12">
                        <div class="alert alert-info" id="noChartsMessage" style="display: none;">
                            No chart data found. <a href="{{ url_for('add_data') }}">Add some data</a> to see charts here.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript to load charts dynamically -->
    <script>
    // Store chart data globally for edit functionality
    let allChartsData = [];

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/my-chart-data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(charts => {
                allChartsData = charts; // Store for later use
                const container = document.getElementById('chartsContainer');
                const noChartsMessage = document.getElementById('noChartsMessage');
                
                if (charts.length === 0) {
                    noChartsMessage.style.display = 'block';
                    return;
                }
                
                noChartsMessage.style.display = 'none';
                
                charts.forEach((chart, index) => {
                    const chartCol = document.createElement('div');
                    chartCol.className = 'col-md-6 mb-4';
                    
                    const chartCard = document.createElement('div');
                    chartCard.className = 'card';
                    
                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'card-header bg-light d-flex justify-content-between align-items-center';
                    
                    const chartTitle = document.createElement('h5');
                    chartTitle.className = 'card-title mb-0';
                    if (chart.is_shared) {
                        chartTitle.innerHTML = `${chart.chart_name} <small class="text-muted">(by ${chart.owner_username})</small>`;
                    } else {
                        chartTitle.textContent = chart.chart_name;
                    }
                    
                    // Dropdown menu for chart options (only show for own charts)
                    if (!chart.is_shared) {
                        const dropdown = document.createElement('div');
                        dropdown.className = 'dropdown';
                        
                        const dropdownButton = document.createElement('button');
                        dropdownButton.className = 'btn btn-sm btn-outline-secondary dropdown-toggle';
                        dropdownButton.type = 'button';
                        dropdownButton.setAttribute('data-bs-toggle', 'dropdown');
                        dropdownButton.setAttribute('aria-expanded', 'false');
                        dropdownButton.innerHTML = '<i class="fas fa-cog"></i>';
                        
                        const dropdownMenu = document.createElement('ul');
                        dropdownMenu.className = 'dropdown-menu';
                        
                        // Edit Data option
                        const editItem = document.createElement('li');
                        const editLink = document.createElement('a');
                        editLink.className = 'dropdown-item';
                        editLink.href = `/edit-data/${chart.id}`;
                        editLink.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Data';
                        editItem.appendChild(editLink);
                        
                        // Customize Styles option
                        const stylesItem = document.createElement('li');
                        const stylesLink = document.createElement('a');
                        stylesLink.className = 'dropdown-item';
                        stylesLink.href = `/customize-chart/${chart.id}`;
                        stylesLink.innerHTML = '<i class="fas fa-palette me-2"></i>Customize Styles';
                        stylesItem.appendChild(stylesLink);
                        
                        dropdownMenu.appendChild(editItem);
                        dropdownMenu.appendChild(stylesItem);
                        
                        dropdown.appendChild(dropdownButton);
                        dropdown.appendChild(dropdownMenu);
                        
                        cardHeader.appendChild(chartTitle);
                        cardHeader.appendChild(dropdown);
                    } else {
                        // For shared charts, just show the title and a shared badge
                        const sharedBadge = document.createElement('span');
                        sharedBadge.className = 'badge bg-info';
                        sharedBadge.textContent = 'Shared';
                        
                        const titleContainer = document.createElement('div');
                        titleContainer.className = 'd-flex align-items-center';
                        titleContainer.appendChild(chartTitle);
                        titleContainer.appendChild(sharedBadge);
                        
                        cardHeader.appendChild(titleContainer);
                    }
                    
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    
                    const canvas = document.createElement('canvas');
                    canvas.id = `chart-${chart.id}-${index}`;
                    canvas.height = '250';
                    
                    cardBody.appendChild(canvas);
                    chartCard.appendChild(cardHeader);
                    chartCard.appendChild(cardBody);
                    chartCol.appendChild(chartCard);
                    container.appendChild(chartCol);
                    
                    // Use custom colors if available, otherwise use default colors
                    const colors = chart.custom_colors && chart.custom_colors.length > 0 ? 
                                  chart.custom_colors : getDefaultColors(chart.rows.length);
                    
                    // Create datasets for each row
                    const datasets = chart.rows.map((row, rowIndex) => {
                        return {
                            label: row,
                            data: chart.values[rowIndex],
                            backgroundColor: colors[rowIndex],
                            borderColor: colors[rowIndex],
                            borderWidth: 2
                        };
                    });
                    
                    new Chart(canvas, {
                        type: chart.type,
                        data: {
                            labels: chart.columns,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: chart.chart_title || chart.chart_name
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label || '';
                                            const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                                            const column = chart.columns[context.dataIndex];
                                            return `${label} - ${column}: ${value}`;
                                        }
                                    }
                                }
                            },
                            scales: chart.type !== 'pie' && chart.type !== 'doughnut' ? {
                                x: {
                                    title: {
                                        display: !!chart.x_axis_label,
                                        text: chart.x_axis_label || ''
                                    }
                                },
                                y: {
                                    title: {
                                        display: !!chart.y_axis_label,
                                        text: chart.y_axis_label || ''
                                    },
                                    beginAtZero: true
                                }
                            } : {}
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error loading charts:', error);
                document.getElementById('noChartsMessage').textContent = 'Error loading charts. Please try again.';
                document.getElementById('noChartsMessage').style.display = 'block';
            });
    });

    // Function to get chart ID by name
    function getChartId(chartName) {
        const chart = allChartsData.find(c => c.chart_name === chartName);
        return chart ? chart.id : 0;
    }

    // Function to get default colors
    function getDefaultColors(count) {
        const defaultColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#8AC926', '#1982C4',
            '#6A4C93', '#F15BB5', '#00BBF9', '#00F5D4'
        ];
        return defaultColors.slice(0, count);
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
